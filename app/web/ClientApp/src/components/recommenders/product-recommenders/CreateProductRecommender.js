import React from "react";
import { useHistory } from "react-router-dom";
import { useAccessToken } from "../../../api-hooks/token";
import { useProducts } from "../../../api-hooks/productsApi";
import { useTouchpoints } from "../../../api-hooks/touchpointsApi";
import {
  createTouchpointMetadata,
  fetchTouchpoint,
} from "../../../api/touchpointsApi";
import { createProductRecommender } from "../../../api/productRecommendersApi";
import {
  Title,
  BackButton,
  Selector,
  AsyncButton,
  ErrorCard,
} from "../../molecules";
import {
  TextInput,
  InputGroup,
  commonIdValidator,
} from "../../molecules/TextInput";

export const CreateProductRecommender = () => {
  const token = useAccessToken();
  const history = useHistory();
  const [error, setError] = React.useState();
  const products = useProducts();
  const productOptions = products.items
    ? products.items.map((p) => ({ label: p.name, value: p.commonId }))
    : [];

  const [selectedProducts, setSelectedProducts] = React.useState();
  const [recommender, setRecommender] = React.useState({
    commonId: "",
    name: "",
    touchpoint: "",
    productIds: null,
    defaultProductId: "",
  });

  const allTouchpoints = useTouchpoints();

  const [loading, setLoading] = React.useState(false);
  const createRecommenderAfterTouchpoint = (tp) => {
    setLoading(true);
    recommender.touchpoint = tp.commonId;
    createProductRecommender({
      success: (pr) =>
        history.push(`/recommenders/product-recommenders/detail/${pr.id}`),
      error: setError,
      token,
      payload: recommender,
      onFinally: () => setLoading(false),
    });
  };

  const handleCreate = () => {
    setLoading(true);
    if (
      allTouchpoints.items &&
      allTouchpoints.items.some((_) => _.commonId === recommender.commonId)
    ) {
      fetchTouchpoint({
        success: createRecommenderAfterTouchpoint,
        error: setError,
        token,
        id: recommender.commonId,
      });
    } else {
      createTouchpointMetadata({
        success: createRecommenderAfterTouchpoint,
        error: setError,
        token,
        payload: {
          commonId: recommender.commonId,
          name: `Autogenerated for Product Recommender (${recommender.commonId})`,
        },
        onFinally: () => setLoading(false),
      });
    }
  };

  return (
    <React.Fragment>
      <BackButton
        className="float-right"
        to="/recommenders/product-recommenders"
      >
        Product Recommenders
      </BackButton>
      <Title>Create Product Recommender</Title>
      <hr />
      {error && <ErrorCard error={error} />}

      <InputGroup>
        <TextInput
          label="Display Name"
          value={recommender.name}
          placeholder="A memorable name that you recognise later."
          onChange={(e) =>
            setRecommender({
              ...recommender,
              name: e.target.value,
            })
          }
        />
      </InputGroup>

      <InputGroup>
        <TextInput
          label="Common Id"
          value={recommender.commonId}
          placeholder="A unique ID for this recommender resource."
          validator={commonIdValidator}
          onChange={(e) =>
            setRecommender({
              ...recommender,
              commonId: e.target.value,
            })
          }
        />
      </InputGroup>

      <div className="m-2">
        <Selector
          isMulti
          isSearchable
          placeholder="Select products. Leave empty to include all products."
          noOptionsMessage={(inputValue) => "No Products Available"}
          defaultValue={selectedProducts}
          onChange={(so) => {
            setSelectedProducts(so);
            setRecommender({
              ...recommender,
              productIds: so.map((o) => o.value),
            });
          }}
          options={productOptions}
        />
      </div>

      <div className="m-2">
        Default Product
        <Selector
          isSearchable
          placeholder="Choose a default product."
          noOptionsMessage={(inputValue) => "No Products Available"}
          onChange={(so) => {
            setRecommender({
              ...recommender,
              defaultProductId: so.value,
            });
          }}
          options={productOptions}
        />
      </div>
      <div>
        <AsyncButton
          onClick={handleCreate}
          loading={loading || allTouchpoints.loading}
        >
          Create
        </AsyncButton>
      </div>
    </React.Fragment>
  );
};
